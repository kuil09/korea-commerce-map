name: Platform Screenshot Preview

on:
  pull_request:
    paths:
      - 'data/platforms.yaml'

permissions:
  contents: read
  pull-requests: write

jobs:
  screenshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}

      - name: Detect new/modified platforms
        id: detect
        run: |
          PLATFORMS=$(node scripts/detect-new-platforms.js origin/${{ github.base_ref }} HEAD 2>&1 | tail -n +6 | grep -A 1000 'ğŸ“¤ JSON ì¶œë ¥:' | tail -n +2 || echo '[]')
          echo "platforms=$PLATFORMS" >> $GITHUB_OUTPUT
          echo "Detected platforms: $PLATFORMS"

      - name: Capture screenshots
        if: steps.detect.outputs.platforms != '[]' && steps.detect.outputs.platforms != ''
        run: |
          mkdir -p screenshots
          echo '${{ steps.detect.outputs.platforms }}' | node scripts/capture-screenshots.js
        env:
          SCREENSHOTS_DIR: ./screenshots

      - name: Upload screenshots as artifact
        if: steps.detect.outputs.platforms != '[]' && steps.detect.outputs.platforms != ''
        uses: actions/upload-artifact@v4
        with:
          name: platform-screenshots
          path: screenshots/
          retention-days: 7

      - name: Create PR comment with screenshots
        if: steps.detect.outputs.platforms != '[]' && steps.detect.outputs.platforms != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // ê²°ê³¼ JSON ì½ê¸°
            const resultsPath = './screenshots/results.json';
            if (!fs.existsSync(resultsPath)) {
              console.log('No results file found');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            
            if (results.length === 0) {
              console.log('No platforms to report');
              return;
            }
            
            // ë§ˆí¬ë‹¤ìš´ ìƒì„±
            let body = '## ğŸ“¸ í”Œë«í¼ ìŠ¤í¬ë¦°ìƒ· ë¯¸ë¦¬ë³´ê¸°\n\n';
            body += '> ì•„ë˜ëŠ” PRì—ì„œ ì¶”ê°€/ë³€ê²½ëœ í”Œë«í¼ì˜ ì‹¤ì œ ì›¹ì‚¬ì´íŠ¸ í™”ë©´ì…ë‹ˆë‹¤.\n';
            body += '> ìŠ¤í¬ë¦°ìƒ·ì€ [Actions ì•„í‹°íŒ©íŠ¸](../actions/runs/${{ github.run_id }})ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n';
            
            for (const result of results) {
              const changeLabel = result.changeType === 'added' ? 'ğŸ†• ì‹ ê·œ ì¶”ê°€' : 'ğŸ”„ URL ë³€ê²½';
              
              body += `### ${result.name} (${result.nameEn})\n\n`;
              body += `| í•­ëª© | ë‚´ìš© |\n`;
              body += `|------|------|\n`;
              body += `| ë³€ê²½ ìœ í˜• | ${changeLabel} |\n`;
              body += `| URL | ${result.url} |\n`;
              
              if (result.success) {
                body += `| ìƒíƒœ | âœ… ìº¡ì²˜ ì„±ê³µ |\n\n`;
                
                // ìŠ¤í¬ë¦°ìƒ·ì„ base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ ì‚½ì…
                const screenshotPath = result.screenshotPath;
                if (fs.existsSync(screenshotPath)) {
                  const imageData = fs.readFileSync(screenshotPath);
                  const base64 = imageData.toString('base64');
                  body += `<details>\n<summary>ğŸ“· ìŠ¤í¬ë¦°ìƒ· ë³´ê¸° (í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸°)</summary>\n\n`;
                  body += `![${result.name}](data:image/png;base64,${base64})\n\n`;
                  body += `</details>\n\n`;
                }
              } else {
                body += `| ìƒíƒœ | âŒ ìº¡ì²˜ ì‹¤íŒ¨ |\n`;
                body += `| ì˜¤ë¥˜ | ${result.error} |\n\n`;
              }
              
              body += '---\n\n';
            }
            
            // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ“¸ í”Œë«í¼ ìŠ¤í¬ë¦°ìƒ· ë¯¸ë¦¬ë³´ê¸°')
            );
            
            if (botComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('Updated existing comment');
            } else {
              // ìƒˆ ì½”ë©˜íŠ¸ ì‘ì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
              console.log('Created new comment');
            }

      - name: No changes comment
        if: steps.detect.outputs.platforms == '[]' || steps.detect.outputs.platforms == ''
        uses: actions/github-script@v7
        with:
          script: |
            console.log('No new or modified platforms detected. Skipping screenshot comment.');
