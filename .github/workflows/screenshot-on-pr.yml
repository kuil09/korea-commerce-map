name: Platform Screenshot Preview

on:
  pull_request:
    paths:
      - 'data/platforms.yaml'

permissions:
  contents: read
  pull-requests: write

jobs:
  screenshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm install playwright@1.49.1
          npx playwright install chromium --with-deps

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}

      - name: Detect new/modified platforms
        id: detect
        run: |
          mkdir -p screenshots
          node scripts/detect-new-platforms.js origin/${{ github.base_ref }} HEAD screenshots/platforms.json
          
          # Read the JSON file and set output
          if [ -f screenshots/platforms.json ]; then
            PLATFORMS=$(cat screenshots/platforms.json)
            # Check if array is empty
            if [ "$PLATFORMS" = "[]" ]; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Capture screenshots
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          cat screenshots/platforms.json | node scripts/capture-screenshots.js
        env:
          SCREENSHOTS_DIR: ./screenshots

      - name: Upload screenshots as artifact
        if: steps.detect.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: platform-screenshots
          path: screenshots/
          retention-days: 7

      - name: Create PR comment with screenshots
        if: steps.detect.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // GitHub comment bodyì˜ ìµœëŒ€ ê¸¸ì´ (65536ì)
            const MAX_BODY_LENGTH = 65536;
            
            // ê²°ê³¼ JSON ì½ê¸°
            const resultsPath = './screenshots/results.json';
            if (!fs.existsSync(resultsPath)) {
              console.log('No results file found');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            
            if (results.length === 0) {
              console.log('No platforms to report');
              return;
            }
            
            // ì•„í‹°íŒ©íŠ¸ URL ìƒì„±
            const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }}`;
            
            /**
             * ìŠ¤í¬ë¦°ìƒ· ì´ë¯¸ì§€ë¥¼ í¬í•¨í•œ ë§ˆí¬ë‹¤ìš´ ìƒì„±
             * @param {boolean} includeImages - base64 ì´ë¯¸ì§€ í¬í•¨ ì—¬ë¶€
             * @returns {string} ë§ˆí¬ë‹¤ìš´ ë¬¸ìì—´
             */
            function generateBody(includeImages) {
              let body = '## ğŸ“¸ í”Œë«í¼ ìŠ¤í¬ë¦°ìƒ· ë¯¸ë¦¬ë³´ê¸°\n\n';
              body += '> ì•„ë˜ëŠ” PRì—ì„œ ì¶”ê°€/ë³€ê²½ëœ í”Œë«í¼ì˜ ì‹¤ì œ ì›¹ì‚¬ì´íŠ¸ í™”ë©´ì…ë‹ˆë‹¤.\n';
              body += `> ìŠ¤í¬ë¦°ìƒ·ì€ [GitHub Actions ì•„í‹°íŒ©íŠ¸](${artifactUrl})ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n`;
              
              if (!includeImages) {
                body += '> âš ï¸ ìŠ¤í¬ë¦°ìƒ· ìˆ˜ê°€ ë§ì•„ ì´ë¯¸ì§€ê°€ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤. ì•„í‹°íŒ©íŠ¸ì—ì„œ ë‹¤ìš´ë¡œë“œí•´ ì£¼ì„¸ìš”.\n\n';
              }
              
              for (const result of results) {
                const changeLabel = result.changeType === 'added' ? 'ğŸ†• ì‹ ê·œ ì¶”ê°€' : 'ğŸ”„ URL ë³€ê²½';
                
                body += `### ${result.name} (${result.nameEn})\n\n`;
                body += `| í•­ëª© | ë‚´ìš© |\n`;
                body += `|------|------|\n`;
                body += `| ë³€ê²½ ìœ í˜• | ${changeLabel} |\n`;
                body += `| URL | ${result.url} |\n`;
                
                if (result.success) {
                  body += `| ìƒíƒœ | âœ… ìº¡ì²˜ ì„±ê³µ |\n\n`;
                  
                  // includeImagesê°€ trueì´ê³  ìŠ¤í¬ë¦°ìƒ· íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ ì‚½ì…
                  if (includeImages) {
                    const screenshotPath = result.screenshotPath;
                    if (screenshotPath && fs.existsSync(screenshotPath)) {
                      const imageData = fs.readFileSync(screenshotPath);
                      const base64 = imageData.toString('base64');
                      body += `<details>\n<summary>ğŸ“· ìŠ¤í¬ë¦°ìƒ· ë³´ê¸° (í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸°)</summary>\n\n`;
                      body += `![${result.name}](data:image/png;base64,${base64})\n\n`;
                      body += `</details>\n\n`;
                    }
                  }
                } else {
                  body += `| ìƒíƒœ | âŒ ìº¡ì²˜ ì‹¤íŒ¨ |\n`;
                  body += `| ì˜¤ë¥˜ | ${result.error} |\n\n`;
                }
                
                body += '---\n\n';
              }
              
              return body;
            }
            
            // ë¨¼ì € ì´ë¯¸ì§€ í¬í•¨ ë²„ì „ ìƒì„±
            let body = generateBody(true);
            
            // ê¸¸ì´ê°€ ìµœëŒ€ì¹˜ë¥¼ ì´ˆê³¼í•˜ë©´ ì´ë¯¸ì§€ ì—†ëŠ” ë²„ì „ìœ¼ë¡œ ëŒ€ì²´
            if (body.length > MAX_BODY_LENGTH) {
              console.log(`Comment body too long (${body.length} chars), generating without images`);
              body = generateBody(false);
            }
            
            // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ“¸ í”Œë«í¼ ìŠ¤í¬ë¦°ìƒ· ë¯¸ë¦¬ë³´ê¸°')
            );
            
            /**
             * ì½”ë©˜íŠ¸ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
             * @param {string} commentBody - ì½”ë©˜íŠ¸ ë³¸ë¬¸
             */
            async function postComment(commentBody) {
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody
                });
                console.log('Updated existing comment');
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody
                });
                console.log('Created new comment');
              }
            }
            
            try {
              await postComment(body);
            } catch (error) {
              // body í¬ê¸° ì´ˆê³¼ ë“±ì˜ ì˜¤ë¥˜ ì²˜ë¦¬
              console.log(`Error posting comment: ${error.message}`);
              console.log('Attempting to post without images...');
              
              // ì´ë¯¸ì§€ ì—†ëŠ” ê°„ë‹¨í•œ ë²„ì „ìœ¼ë¡œ ì¬ì‹œë„
              const fallbackBody = generateBody(false);
              
              try {
                await postComment(fallbackBody);
                console.log('Posted comment without images');
              } catch (fallbackError) {
                // ìµœì¢… fallback: ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ë¹Œë“œëŠ” ê³„ì† ì§„í–‰
                console.log(`Failed to post fallback comment: ${fallbackError.message}`);
                console.log('Skipping comment - screenshots are available in artifacts');
              }
            }

      - name: No changes comment
        if: steps.detect.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('No new or modified platforms detected. Skipping screenshot comment.');
